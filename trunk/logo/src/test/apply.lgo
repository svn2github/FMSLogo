LOAD "testlib.lgo

TO APPLYTEST.NONPRIMITIVE :A :B
   OUTPUT SUM :A :B
END

TO APPLYTEST.NOOUTPUT
   STOP
END

TO APPLYTEST.APPLYOUTPUT
  APPLY [OUTPUT ?] [3]
END

TO APPLYTEST.BUG1519088
  ; bug #1519088 -- this used to leak memory 
  SIMPLEREPORTTEST [ APPLYTEST.APPLYOUTPUT ] 3

  ; REVISIT: I can't figure out how to run this code without
  ; halting automation.
  ; RUNEXPECTERRORTEST [ APPLY [ OUTPUT ? ] [3] ] 30
END


TO APPLYTEST.SMOKETEST

   ; apply a primitive
   SIMPLEREPORTTEST [APPLY "SUM [123]      ] 123
   SIMPLEREPORTTEST [APPLY "SUM [100 20 3] ] 123

   ; apply a non-primitive procedure that has already been defined
   SIMPLEREPORTTEST [APPLY "APPLYTEST.NONPRIMITIVE [120 3] ] 123

   ; apply a library procedure that must get loaded
   TRACEINSTRUCTION [ERASE "ARRAYTOLIST]
   SIMPLEREPORTTEST [APPLY "ARRAYTOLIST [{1 2 3}] ] [1 2 3]

   ; apply a procedure in the current directory that must get loaded
   TRACEINSTRUCTION [ERASE "procedureinworkingdirectory]
   SIMPLEREPORTTEST [APPLY "procedureinworkingdirectory [] ] 123

   TRACEINSTRUCTION [APPLY "APPLYTEST.NOOUTPUT [] ]

   ; this is legal for some reason
   SIMPLEREPORTTEST [APPLY [1] []] 1

   ; apply can be nested
   SIMPLEREPORTTEST [APPLY "APPLY [SUM [100 20 3]]] 123
END


TO APPLYTEST.BADINPUT
    
   RUNNOTENOUGHINPUTSTEST [(APPLY "SUM)]
   RUNTOOMANYINPUTSTEST   [(APPLY "SUM [1 2 3] "toomany)]

   RUNNONRECOVERABLEIDONTKNOWHOWTOTEST  [APPLY "NONEXISTENT [1 2 3]]
   RUNNONRECOVERABLEIDONTKNOWHOWTOTEST  [APPLY "TO          []]
   RUNNONRECOVERABLEIDONTKNOWHOWTOTEST  [APPLY 1            []]

   RUNBADINPUTTEST   [APPLY {1 2 3} [1 2 3]]
   RUNBADINPUTTEST   [APPLY [1 2 3] [1 2 3]]
   RUNBADINPUTTEST   [APPLY "SUM    {1 2 3}]

   ; the function being called has bad inputs
   RUNNOTENOUGHINPUTSTEST [APPLY "APPLYTEST.NONPRIMITIVE [1]]
   RUNTOOMANYINPUTSTEST   [APPLY "APPLYTEST.NONPRIMITIVE [1 2 3]]

END

TO APPLYTEST.TEMPLATE

   ; applying a template with empty lines used to crash
   TRACEINSTRUCTION [ APPLY [[][]] [] ]
END

TO APPLYTEST

   APPLYTEST.SMOKETEST
   APPLYTEST.BADINPUT
   APPLYTEST.BUG1519088
   APPLYTEST.TEMPLATE
END

